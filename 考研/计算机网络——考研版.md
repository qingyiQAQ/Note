# 第一章 计算机网络体系结构

## 1.1计算机网络概述

### 1、定义

计算机网络是一个将众多**分散的、自治的**计算机系统，通过**通信设备与线路**连接起来，由功能完善的**软件**实现**资源共享和信息传递**的系统。

### 2、组成

由若干**结点**（node）和连接这些结点的**链路**（link）组成。

### 3、主要功能

数据通信（信息传递）、资源共享

结点：集线器（连接多个计算机）、交换机（连接多个计算机）、路由器（连接计算机网络）

互联网（因特网）必须使用TCP/IP协议

互连网（局域网）可以使用任意协议

ISP（Internet Service Provider），互联网服务提供商

### 4、组成

从组成部分看：硬件（主机、通信设备、链路）、软件、协议

从工作方式看：边缘部分（主机、软件）、核心部分（网络、路由器）

从逻辑功能看：资源子网，通信子网

### 5、功能

数据通信（最基本，最重要）、资源共享、分布式处理、提高可靠性、负载均衡

### 6、分类

（1）分布范围：广域网WAN、城域网MAN、局域网LAN、个人区域网PAN

广域网采用交换技术，局域网采用广播技术（以太网技术）

（2）传输方式：广播式网络（局域）、点对点网络（广域）

（3）拓扑结构：总线（集线器，广播式）、星型（以太网交换机）、环形（令牌环）、网状（广域）

（4）使用者：公用网、私用网（银行）

（5）交换技术

**电路交换**：建立连接、传输数据、断开连接
（时延小、线路利用率低、无差错控制）

**报文交换**（存储-转发网络）：整个报文传送到相邻结点，全部存储后查找转发表，转发到下一个结点
（资源开销大、线路利用充分）

**分组交换**（包交换）：将数据分为固定长度数据块，加上包头制成报文再转发
（时延较小、易于管理）

### 7、性能指标

带宽：数字信道上传输速率的**最大**值，单位：b/s

时延：需要的时间，单位：s（包括：发送时延，传播时延）

![image-20240821141801036](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240821141801036.png)

时延带宽积：传播时延*信道带宽，单位：b

往返时延（RTT）：发送端**发送完**信息到收到来自接收端确认的时间。

![image-20240821141219562](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240821141219562.png)

吞吐量：单位时间内通过某个网络（信道）的数据量

速率：传输速率

信道利用率：有数据通过的时间/总时间

![image-20240821140837195](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240821140837195.png)

8、**最早的计算机网络**：**ARPAnet**

## 1.2计算机网络体系结构与参考模型

### 1、基本概念

服务数据单元（SDU）：用户需要传输的数据

协议控制信息（PCI）：控制协议操作的信息，如：头部

协议数据单元（PDU）：对等层次之间传送的数据单位

n-PDU = n-PCI+n-SDU = (n-1)-SDU

### 2、协议、接口、服务

协议：为进行网络中的数据交换而建立的规则、标准或约定。（由语法、语义、同步组成）

接口：同一结构相邻两层间交换信息的连接点，通过**服务访问点（SAP）**进行交互。

服务：下层为紧邻的上层的功能调用。（服务原语：请求，指示，响应，证实）

面向连接的服务：通信之前必须建立连接，如TCP。
无连接的服务：IP、UDP

可靠服务：保证数据正确可靠的传输到目的地，如TCP
不可靠服务：如UDP

有应答服务、无应答服务

### 3、ISO/OSI参考模型

自下而上，低三层为**传输子网**，高三层为**资源子网**。

（1）物理层：传输单位是**原始比特流**，定义数据终端设备（DTE）和数据通信设备（DCE）的物理与逻辑连接方法。协议有：EIA-232C、EIA/TIA RS-449、CCITT等。

（2）数据链路层

传输单位是**帧**，功能为**成帧**、**差错控制**、**流量控制**和**传输管理**。协议有：SDLC、HDLC、PPP、STP、帧中继等。

（3）网络层

传输单位是**数据报或分组**，为分组交换网上的不同主机提供通信服务，功能有**路由选择**、**分组转发**、**拥塞控制**、**网际互连**、**差错控制**、**流量控制**、**连接建立与释放**、**可靠传输**。协议有：IP、IPX、ICMP、IGMP、ARP、RARP、OSMF等。

（4）传输层

传输单位是**段或报文段（TCP）或用户数据报（UDP）**，负责主机中两个**进程**的通信，功能有**复用和分用**、**流量控制**、**差错控制**、**服务质量**、**数据传输管理**。协议有：UDP、TCP。

（5）会话层

允许不同主机上的各个进程进行会话（SYN），功能有**建立、管理以及终止进程间的会话**，**数据同步**。（检查点机制：通信失效时从检查点恢复通信）

（5）表示层

传输单位是**报文**。处理两个通信系统中交换信息的方式。功能有**数据压缩**、**加密和解密**。协议有：YSCS。（数据格式转化）

（6）应用层

用户与网络界面，协议有：FTP（文件传输）、SMTP（电子邮件）、HTTP（万维网）。

![image-20240822150256357](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240822150256357.png)

![image-20240822151907059](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240822151907059.png)

![image-20240822151948984](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240822151948984.png)

### 4、TCP/IP模型

从低到高

（1）网络接口层（物理层+数据链路层）

（2）网际层

（3）传输层

（4）应用层（会话层+表示层+应用层）

**网络层及以下层的传输不再可靠**（尽最大努力），在传输层进行差错控制、流量控制、可靠传输管理。

![image-20240822172114193](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240822172114193.png)

### 5、学习模型

（1）物理层

（2）数据链路层

（3）网络层

（4）传输层

（5）应用层

# 第二章 物理层

## 2.1通信基础

### 1、基本概念

数据：传送信息的实体

信源：产生和发送数据的源头

信宿：接收数据的终点

信道：信号的通道，通常包含**发送信道**和**接收信道**

信号：数字的载体，分为**数字信号**（离散）和**模拟信号**（连续）

**码元**：用一个固定时长的信号波形表示一位k进制数字（一个码元携带3bit的数据则为2^3^=8进制码元）

**波特率**（码元传输速率）：每秒传输的码元个数，单位：码元/秒，波特

**带宽**：某信道允许通过的信号频带范围，单位：Hz

### 2、奈奎斯特定理

对于一个理想低通信道（没有噪声，带宽有限）最多可以传输2W个码元

W是信道的**频率带宽**

极限波特率=2W（单位：波特）=2W*log~2~K（单位：bps）

K为不同码元的个数

### 3、香农定理

对于一个有噪声，带宽有限的信道

极限比特率=Wlog~2~(1+S/N)（单位：b/s）

**信噪比**=S/N=信号功率/噪声功率（无单位）（采用这个）

信噪比=10log~10~S/N（单位：分贝db）

### 3、编码与调制

调制：将数据变换为模拟数据（光猫）

编码：将数据变换为数字信号（网卡）

常用的编码方式：

![image-20240823132155991](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240823132155991.png)

以太网使用**曼彻斯特**

常用的调制方式：

![image-20240823133548934](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240823133548934.png)

**正交振幅调制**（QAM）同时调节**振幅**和**相位**

## 2.2传输介质

### 1、双绞线

两根导线相互**绞合**而成，用于**局域网，电话网**

有屏蔽层=屏蔽双绞线（STP）
无屏蔽层=非屏蔽双绞线（UTP）

绞合是为了提升抗干扰能力

### 2、同轴电缆

内导体+外导体屏蔽层

抗干扰能力**更好**

内导体越粗->电阻越低->传输距离越长

### 3、光纤

单模：只有一条光线在光纤中传输，适合**远距离**
多模（MMF）：多条光线在一条光纤中传输，适合**近距离**

抗干扰能力**最好**

传输距离极好

### 4、介质命名规范

速度单位Mbps

介质信息：不写（同轴电缆）、F（光纤）、T（双绞线）

![image-20240823204541796](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240823204541796.png)

### 5、无线电波

应用：手机、WiFi

特点：穿透能力强、传输距离长、信号指向性弱

### 6、微波通信

应用：卫星通信

特点：频率带宽高、信号指向性强、保密性差

### 7、物理层接口特性

机械特性（参数）、电气特性（限制）、功能特性（意义）、过程特性（顺序）

![image-20240823205242919](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240823205242919.png)

## 3.3物理层设备

### 1、中继器

对信号进行**再生**和**还原**

两端是完全相同的两类网络

不能存储转发

**5-4-3规则**：最多4个中继器连接5个传输介质，挂接不超过3个计算机

### 2、集线器（Hub）

多端口中继器

对信号进行**再生放大**，发送到其他所有端口上

会产生**冲突**

# 第三章 数据链路层

## 3.1数据链路层的功能

### 1、为网络层提供服务

（1）无确认无连接服务：不需先建立连接，也不需发回确认。（用于实时通信）
（2）有确认的无连接服务：不需先建立连接，收到数据必须发回确认。
（3）有确认的面向连接服务：建立数据链路、传输帧、释放数据链路，收到的每一帧都要给出确认。

### 2、链路管理

用于面向连接的服务（管理连接的建立、维持和释放）

### 3、组帧

给网络层的分组添加**首部**和**尾部**构成帧

### 4、流量控制

限制发送方的数据流量，使发送速率<接收速率

### 5、差错控制（位错/帧错）

使发送方确定接收方是否正确收到发送的数据

## 3.2组帧

帧定界：确定帧的界限

帧同步：接收方能区分出帧的**起始**和**终止**

最大传输单元（MTU）：**数据部分**的传输上限

透明传输：不管传输的数据是什么样的比特组合，都应能传输

### 1、字符计数法

使用帧首部的一个**计数字段**（第一个字节，8位）来标明**帧内字符数**（包括自身）

### 2、字符填充法

**特定字符**来界定帧的开始和结束

首部：**SOH**，尾部：**EOT**

发送方：如果数据中出现SOH或EOT则在前面加上**转义字符ESC**

接收方：删除所有转义字符

### 3、零比特填充法

首部：**01111110**，尾部：**01111110**

发送方：有连续**5个1**在后面填一个0

接收方：遇到**5个1**自动删除一个0

### 4、违规编码法

用“高-高”和“低-低”两种违规电平来标志帧的起始和终止

！！现在普遍使用**零比特填充**和**违规编码**

## 3.3差错控制

### 1、检错编码（奇偶/CRC）

（1）奇偶校验码

n-1位信息元，1位校验元

奇校验码：n个数中1的个数为奇数

偶校验码：n个数中1的个数为偶数

（2）CRC循环冗余码

要传的数据（d位）：被除数

生成多项式（r位）：除数

FCS帧检验序列/冗余码：余数

步骤：
要传的数据d位后加r-1位0
与生成多项式做**模2除法**（异或：相同为0，不同为1）
得到余数为FCS（r-1位）
将FCS补在要传的数据后面（d+r-1位）传输
接收端收到后也做**模2除法**，余数为0则传输正确

### 2、纠错编码（海明）

码距/海明距离：两种合法编码**对应比特取值不同**的比特数，如：1001和0000码距为2。

编码集的海明距离：任意两种合法编码的码距最小值

检错d位数需要码距**d+1**，纠错d位数需要码距**2*d+1**

海明码

（1）确定海明码的位数

有效信息位数d，校验位位数r

海明不等式：d+r<=2^r^-1

（2）确定校验位的分布

校验位一定会在2^n^的位置

![image-20240831210452854](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240831210452854.png)

（3）求出校验码的值

4号位二进制编码为100，那么该位负责所有编号满足1**的位，即4567位

![image-20240831210655250](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240831210655250.png)

（4）检错和纠错

![image-20240831211122568](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240831211122568.png)

## 3.4流量控制和可靠传输机制

### 1、流量控制与滑动窗口机制

流量控制：**接收方**控制**发送方**的发送速率（停止等待协议、滑动窗口协议）

**停止-等待协议**（S-W）：发送窗口W~T~=1，接收窗口W~R~=1，使用**1位**来对帧进行编号就足够

**后退N帧协议**（GBN）：发送窗口W~T~>1，接收窗口W~R~=1，采用**n比特位**对帧编号，有**W~T~+W~R~<=2^n^**，**WT<=2^n^-1**

**选择重传协议**（SR）：发送窗口W~T~>1，接收窗口W~R~>1，**W~T~=W~R~=2^n-1^**

### 2、可靠的传输机制

**自动重传请求（ARQ协议）**：没有收到**确认帧ACK**则重新发送，直到收到为止。

**重传时间**应该比帧传输的**平均RTT**更**长**

发送完必须将**副本**保存在**缓冲区**

分为以下三种：

（1）**停止-等待协议S-W**

有差错：数据帧丢失、确认帧丢失、确认帧迟到

（2）**后退N帧协议GBN**

**累积确认**：连续收到多个帧后，对**最后一个数据帧**发回确认信息

**捎带确认**：接收方**给发送方发送**数据时携带确认信息

**超时重传**：需要传**超时的帧**及其**之后的所有帧（已发送但是未确认）**

（3）**选择重传协议SR**

只有收到窗口的**第一个帧**才能移动

![image-20240918171855339](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240918171855339.png)

**超时重传**：只重传**超时的帧**

### 3、信道利用率的分析

（1）**信道利用率**=T~D~/T=(L/C)/T

C发送方数据传输率

T发送周期=传播时延RTT+L/C

T~D~有效发送数据占的时间

L比特数

![image-20240918194316010](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240918194316010.png)

（2）**信道吞吐率**=信道利用率*发送方发送速率

## 3.5介质访问控制

**介质访问控制（MAC，Multiple Access Control)**

**概念**：防止两对结点之间的通信不会发生**相互干扰**的情况。

**分类**：静态划分信道（信道划分）、动态划分信道（随机访问、轮询访问）

**用于局域网（广播）**

### 1、信道划分访问控制

（1）**频分多路复用FDM**

根据频率划分，相邻频率需要加入**保护带**

（2）**时分多路复用TDM**

**统计时分复用STDM**：按需**动态分配**时隙

（3）**波分多路复用WDM**

用于光纤，将**光波**分为多个频率

（4）**码分多路复用CDM**

**码分多址CDMA**：将1bit分为**多个码片/芯片**，每个站点指定一个**唯一的序列**，发送1时发送原序列，发送0放送序列取反。（0代表-1，1代表+1）

要求各个站点的芯片序列要**正交**（相乘为0）

传输时**线性相加**

分离时**传输数据*原站序列**

![image-20240919175530695](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240919175530695.png)

### 2、随机访问介质访问控制

（1）**ALOHA协议**

**冲突检测**：收不到确认帧（超时重发）

**纯ALOHA**：不监听信道，不按**时间槽**发送，想发就发

**时隙ALOHA**：不监听信道，只能在**时间片开始时**发送

（2）**载波监听多路访问协议CSMA**

**CS**：载波监听，发送前需要**检测**是否有其他计算机在发送数据

发生冲突数据仍然要**全部发完**

**p-坚持用于时隙**

| 信道状态 | 1-坚持             | 非坚持                         | p-坚持                   |
| -------- | ------------------ | ------------------------------ | ------------------------ |
| 空闲     | 立即发送           | 立即发送                       | 以p概率发送，1-p概率推迟 |
| 忙       | 继续监听，直到空闲 | 放弃监听，等待随机时间后再监听 | 继续监听，直到空闲       |

————————**CSMA/CD协议**————————

用于**有线**网

**CD**：碰撞检测，**发送数据时也检测**是否有其他计算机在发送，一旦有**立即停止**发送，用于**半双工网络**

单向传播时延t

**截断二进制指数规避算法**：确定一个基本**退避时间**（争用期2*t），定义参数**k=重传次数&&k<=10**，随机从**连续整数集合{0,1,...,2^k^-1}**选出一个数**r**，则**重传时间=2\*r\*t**，重传**16**次后**报错**。

**最小帧长**：**总线单向传播时延t\*2\*数据传播速率**，以太网最小帧长**64B**，小于64B会填充

————————**CSMA/CA协议**————————

用于**无线**网

**CA**：碰撞避免

空闲时发出**RTS**(request to send)，包括发送端接收端地址，发送持续时间

接收端收到RTS，响应**CTS**(clear to send)

发送端收到CTS才能**开始发送**数据帧

接收端收到数据相应一个**ACK帧**发送端才能继续发送，如果收不到则**重传**（**二进制退避**）

### 3、轮询访问：令牌传递协议

（1）**轮询协议**

有一个**主节点**

主节点**轮流**邀请从属结点发送数据

（2）**令牌传递协议**

令牌环网，逻辑**环形**，物理星型

**令牌**：特殊的MAC帧，确保同一时刻只有一个结点独占，只能持有一定时间

TCU转发器

## 3.6局域网

### 1、概念

**局域网LAN**：某一区域内，多个计算机互联成的计算机组，使用广播信道

**特点**：范围小、数据传输率高、时延低、误码率低

**主要要素**：网络拓扑、传输介质、介质访问控制方法

**拓扑结构**：星型（集线器）、总线型、环形、树型

**分类**：以太网(IEEE802.3)、令牌环(IEEE802.5)、FDDI光纤(IEEE802.8)、无线局域网WLAN(IEEE802.11)

**MAC子层**和**LLC子层**：LLC负责**识别网络协议**，进行封装；MAC负责**帧的封装**

### 2、以太网Ethernet

（1）**概念**

逻辑**总线**、物理星型

**双绞线**+**集线器**

**CSMA/CD**

**无连接**：无握手过程

**不可靠**：不对数据帧**编号**，接收方不向发送方进行**确认**，差错帧直接丢弃

（尽最大努力交付）

**10BASE-T**：**无屏蔽双绞线**、**曼彻斯特编码**、**传输速率10Mb/s**

**网卡**/网络适配器/网络接口板：上面存有**MAC地址**，唯一确定设备地址

（2）**MAC地址**

**MAC地址**：48位二进制地址，前半为厂家，后半为编号，6个十六进制，如：02-60-8c-e4-b1-21，**全1为广播地址**

（3）**MAC帧**

**前导码**：前7字节为**同步码**，后1字节为**定界符**，**不属于帧**

**目的地址/源地址**：MAC地址

FCS：CRC校验码

最小：64字节

最大：1518字节



![image-20240920151135282](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240920151135282.png)

IEEE802.3第三个字段是**长度/类型**

（4）**高速以太网**

100BASE-T：100Mb/s

吉比特以太网：1Gb/s

10吉比特：10Gb/s

### 3、无线局域网WLAN

（1）**MAC帧头**

**AP**：无线接入点/基站

地址1：RA接收端

地址2：TA发送端

地址3：DA目的地址

地址4：SA源地址

![image-20240920152510980](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240920152510980.png)

### 4、虚拟局域网VLAN

将局域网内的设备划分为**与物理位置无关的逻辑组**的技术

不同的VLAN**互不相通**

**类型**：基于接口、基于MAC地址、基于ip地址

![image-20240920154929522](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240920154929522.png)

前**2字节**表明是IEEE802.1Q帧，接下来**4位**没用，后**12位**是VLAN**标识符VID**，取值范围**1-4094**，因为0和4095无效

## 3.7广域网

### 1、概念

使用**结点交换机**连接，用于存储转发**分组**，采用**点对点**连接

### 2、点对点协议PPP

只支持**全双工**链路

帧长为**整数个字节**

**同步**使用**比特**传输，**异步**按照**字节**传输

组成部分：链路控制协议**LCP**（管理链路连接）、网络控制协议**NCP**（协调网络层协议，每个网络层协议都要一个NCP）、封装**IP数据报**

**标志字段F**：7E，首尾各有一个，为**帧定界**符，其他地方遇到该字符会在前面插入一个转义字符7D

**地址字段A**：FF，未定义

**控制字段C**：03，未定义

**协议段**：**0021为IP数据报**，C021为LCP数据

![image-20240921144911318](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240921144911318.png)

## 3.8数据链路层设备

|            | 能否隔离冲突域 | 能否隔离广播域 |
| ---------- | -------------- | -------------- |
| 物理层设备 | 不能           | 不能           |
| 链路层设备 | 能             | 不能           |
| 网络层设备 | 能             | 能             |

### 1、网桥

根据MAC帧的**目的地址**对帧进行**转发**和**过滤**，不会进行广播

分类：透明网桥、源路由网桥

### 2、以太网交换机

**多接口网桥**，每个端口连接一个**冲突域**

（1）**直通式交换机**

查完目的地址**立刻转发**，无法支持不同速率的端口交换

**转发延迟**=目的地址长度6B/转发速率

（2）**存储转发式交换机**

**正确即转发**，错误即丢弃，支持**不同速率**的端口交换

**转发表**：存储每次发送哪个**主机**来自哪个**接口**

![image-20240921153021477](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240921153021477.png)

# 第四章 网络层

## 4.1网络层的功能

**传输单位**：**数据报**

将**数据报**划分为不同的**分组**，进行路由选择和转发

**功能**：路由选择、分组转发、异构网络互联、拥塞控制

### 2、路由和转发

（1）路由选择：动态维护路由表

（2）分组转发：将分组从合适的端口转发出去

### 3、两种服务

（1）**面向连接**的**虚电路服务**

VC（virtual Circuit）

**需要建立连接**，**不需预分配带宽**

连接一旦建立，发送的线路就**不会再改变**

（2）**无连接**的**数据报服务**

**无需先建立连接**

将**报文**拆分成**分组**，选择**最佳路由**，尽快转发

### 4、软件定义网络SDN

路由器不再负责转发表的计算，而是与远程SDN控制器通信

**数据平面**：根据转发表进行转发

**控制平面**：传统方法（路由选择算法在路由器中）、**SDN方法**（**远程控制器统一计算**转发表给路由器）

**北向接口**：SDN控制器与远程软件交互

**南向接口**：SDN控制器与路由器交互，**OpenFlow协议**

### 5、拥塞控制

**拥塞**：过量的分组引起**网络性能下降**

**判断是否拥塞**：网络负载**上升**，但是网络吞吐量**下降**

**控制方法**：开环控制（设计网络时事先考虑拥塞）、闭环控制（检测系统实时检测，解决拥塞）

## 4.2路由算法

![image-20240923145933468](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240923145933468.png)

### 1、分类

静态路由算法（非自适应路由）：网络管理员手工配置

动态路由算法（自适应路由）：根据网络负载和拓扑结构动态调整自身的算法

### 2、链路状态路由算法

**OSPF协议**

只有**链路状态变化**才会更新

所有路由器完全掌握**完整的网络拓扑**和费用信息

### 3、距离向量路由算法

**RIP协议**

每**30s**更新一次

路由器只与**相邻的路由器**交换**路由表**

路由器只掌握物理**相联的邻居**及链路费用

**距离**：跳数（直接交付距离为1）（距离为**16**表示**不可达**）

**慢收敛**：网络出现故障需要较长时间才能传到所有路由器

### 4、分层次的路由选择协议

将互联网划分为较小的**自治系统**（Autonomous System,AS）

AS内部：内部网关协议IGP（RIP、OSPF）

AS之间：外部网关协议EGP（BGP-4）

### 5、三种协议比较

| 协议     | RIP        | OSPF       | BGP                                  |
| -------- | ---------- | ---------- | ------------------------------------ |
| 类型     | 内部       | 内部       | 外部                                 |
| 协议层数 | 应用层     | 网络层     | 应用层                               |
| 路由算法 | 距离-向量  | 链路状态   | 路径向量                             |
| 传递协议 | UDP        | IP         | TCP                                  |
| 路径选择 | 跳数最少   | 代价最低   | 较好、非最佳                         |
| 交换结点 | 相邻路由器 | 所有路由器 | 相邻路由器                           |
| 交换内容 | 路由表     | 链路状态   | 首次：整个路由表；后续：有变化的部分 |

## 4.3IPv4

### 1、IPv4数据报/分片格式

**头部**：20B

**首部长度**：5-15，**单位：4B**，**首部最大60B**

**总长度**：首部加数据的长度，<=1500，**单位：1B**，**必须是8B的倍数**

**标识**：数据报的编号（相同数据报产生的分组编号相同）

**标志**：3位，**最低位**为MF（**MF=1表示后面还有分组**，MF=0表示最后一个分片；**中间位**为DF（**DF=0允许分片**），第一位无意义

**片偏移**：13位，分片后，在原数据报中的相对位置，**单位：8B**

**生存时间**：TTL，每经过一个路由器-1，TTL=0时必须丢弃

**协议**：数据部分的协议（TCP=6/UDP=17）

**源地址/目的地址**：IP地址

**数据部分**：TCP段/UDP段

![image-20240922190845171](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240922190845171.png)

### 2、分片

（1）分片后长度（首部+数据）不能超过MTU，分片记得减去首部

（2）分片后**数据部分**长度需要是8B的倍数（向下取整）

（3）片偏移量=前面所有分片的**总长**/8B

### 3、IPv4地址

**共32位**，每8位写成一个**十进制**

IP地址={网络号,主机号}

路由器每个**接口**都是一个**IP地址**

（1）**分类**

![image-20240922191727903](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240922191727903.png)

| 网络类别 | 最大可用网段数 | 最大主机数 |
| -------- | -------------- | ---------- |
| A        | 2^7^-2         | 2^24^-2    |
| B        | 2^14^-1        | 2^16^-2    |
| C        | 2^31^-1        | 2^8^-2     |

（2）**特殊IP地址**

| NetID网络号 | HostID主机号    | 作为源地址 | 作为目的地址 | 用途                         |
| ----------- | --------------- | ---------- | ------------ | ---------------------------- |
| 全0         | 全0             | 可以       | 不能         | 本网内本机                   |
| 全0         | 特定值          | 可以       | 不能         | 本网络内特定主机             |
| 全1         | 全1             | 不能       | 可以         | 本网内广播                   |
| 特定值      | 全0             | 不能       | 不能         | 表示一个网络                 |
| 特定值      | 全1             | 不能       | 可以         | 网络内广播                   |
| 127         | 任何（非全0/1） | 可以       | 可以         | 本地软件回环测试（环回地址） |

（3）**私有IP地址**

| 地址类别 | 地址范围                    | 网段个数 |
| -------- | --------------------------- | -------- |
| A类      | 10.0.0.0-10.255.255.255     | 1        |
| B类      | 172.16.0.0-172.31.255.255   | 16       |
| C类      | 192.168.0.0-192.168.255.255 | 256      |

### 4、网络地址转换NAT

在**专用网**连接到**因特网**的路由器上安装NAT软件，他至少要一个有效的**外部全球IP地址**

NAT转换表

将**LAN端**的IP:端口映射到**WAN端**的IP:端口

### 5、子网划分

将**主机号**划分为**子网号**和**主机号**

主机号**不能全0或全1**

（1）**子网掩码**

2级IP地址：网段号全1，主机号全0

3级IP地址：网段号和子网号全1，主机号全0

### 6、无分类编址CIDR

网络前缀=网络号+子网号

在IP地址后加上网络前缀的**位数**（128.14.32.0/20）

**CIDR地址块**：网络前缀相同的连续IP地址

**如何路由？**：与子网掩码**按位相与**，选择具有**最长网络前缀**的路由

### 7、构成超网/路由聚合

两个**路由器表项**合并，合并后IP取IP前面**最大**相同部分（**取交集**）

如：206.1.0.0/17与206.1.128.0/17合并为206.1.0.0/16

### 8、ARP协议

作用：完成主机/路由器**IP地址**到**MAC地址**的映射

**网络层**协议，基于**IP**

**ARP高速缓存**：IP地址和MAC地址的映射

（1）**广播APR请求分组**：MAC地址**全1**

（2）回答**响应分组**（单播）：B的IP与MAC的映射

### 9、DHCP协议

作用：主机从服务器动态**获取IP地址**、子网掩码、默认网关，允许地址重用

**应用层**协议，基于**UDP**

四个过程全为**广播**！

（1）DHCP**发现**报文：主机->DHCP，找到DHCP服务器

（2）DHCP**提供**报文：DHCP->主机，多个DHCP服务器发给主机，拟分配ip地址

（3）DHCP**请求**报文：主机->DHCP，选择一个ip地址，告诉DHCP使用的ip地址

（4）DHCP**确认**报文：DHCP->主机，正式分配ip地址

### 10、ICMP协议

作用：差错报告、网络探寻

**网络层**协议，基于**IP**

（1）**差错报告**类型

终点不可达（无法交付）

源点抑制（网络拥塞）

时间超过（TTL=0）

参数问题（首部字段不正确）

改变路由（重定向）

（2）**询问报文**

回送请求和回答报文（ping，测试是否可达）

时间戳请求和回答报文（时钟同步）

（3）什么时候**不发送**

ICMP差错报告报文出错

第一个分片的后续分片

组播数据报

特殊地址（环回）

## 4.4IPv6

（1）**概念**

长度：128位（16B）

只能在**主机处分片**

**即插即用**（不用DHCP）

**基本首部**：

**没有校验字段**

流标签：相当于IPv4的标识

![image-20240926174352185](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240926174352185.png)

**拓展首部**：放在数据部分中

（2）**表示**

冒号十六进制：每4个十六进制数用冒号隔开，共8组

**0压缩**：

0000->00

04B->4B

0000:0000:0000->::（双冒号只能用一次）

（3）**地址类型**

单播：一对一

多播：一对多

任播：一对多，只发给最近的

## 4.5IP组播/多播

给具有相同需求的**组播组**发消息

在**网络层**，使用**IP数据报**传递，不产生**ICMP报文**

多播在发送**主机**复制消息，组播每经过一次**路由器**复制一次消息

**IP组播地址**：一个**D类地址**表示一个组播组（不能作为源地址）

组播MAC地址：以**01-00-5E**开头，第25位为0，剩下的23位为**IP的低23位**

**IGMP协议**：组播路由选择协议，让**路由器**知道本局域网上参加/退出了组播组的主机

# 第五章 传输层

## 5.1传输层提供的服务

### 1、传输层的功能

（1）应用**进程**之间的通信

（2）复用和分用（复用：不同进程使用同一个传输层协议；分用：传输层剥去首部交给正确的进程）

（3）检错检测（网络层的IP报文只检测头部）

（4）提供面向连接和无连接的传输协议（TCP/UDP）

### 2、端口

传输层的SAP

**长度**：16位（0-65535）

服务端使用：熟知端口号（0-1023，最重要的应用程序）、登记端口号（1024-49151，其他登记的应用进程）

客户端使用：49152-65535

| 应用程序 | FTP  | TELENT | SMTP | DNS  | TFTP | HTTP | SNTP |
| -------- | ---- | ------ | ---- | ---- | ---- | ---- | ---- |
| 端口     | 21   | 23     | 25   | 53   | 69   | 80   | 161  |

套接字=(主机IP地址:端口)，唯一标志一个进程

## 5.2UDP协议

### 1、概述

DNS使用UDP，HTTP使用TCP

**无连接**

首部开销小（8B）

没有**拥塞控制**

UDP不对应用层的报文进行切分

### 2、首部

源端口号：可有可无（不需要则全0）

UDP长度：数据报长度（包括首部+数据）

UDP检验和：可选（不需要则全0），检验头部+数据

![image-20240927153012997](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240927153012997.png)

### 3、UDP检验

**伪首部**：12B，仅用于检验

**协议字段**：**17**

![image-20240927153302984](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240927153302984.png)、

按顺序每**2B**一行（不足2B补0），**求和**后取**反码**

![image-20240927153437073](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240927153437073.png)

收到后同样方法计算结果：**全1则正确**，非全1则错误

## 5.3TCP协议

### 1、概述

需要建立**虚连接**

可靠交付：无差错、不丢失、有序

面向**字节流**

### 2、首部

**长度**：**20B**

**序号seq**：第一个字节的位置

**确认号ack**：**期望**收到对方的**下一个**报文段的数据**字节序号**

**数据偏移**：首部长度，单位：4B

**紧急位URG**：紧急数据，**发送方**尽快发送，不再排队

**确认位ACK**：ACK=1时确认号有效

**推送位PSH**：尽快交付，不再等**接收方**缓存满

**复位RST**：重新建立连接

**同步位SYN**：是一个连接请求/接收报文

**终止位FIN**：要求释放连接

**窗口**：接收窗口，**现在**允许发送的字节数

**检验和**：检验首部+数据，协议字段为6

**紧急指针**：URG=1有效，紧急数据的字节数（从数据开头开始）

![image-20240927154018683](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240927154018683.png)

### 3、连接管理

（1）**连接建立（三次握手）**

1：无数据，请求建立连接，SYN=1，seq=x随机

2：无数据，服务端分配缓存，SYN=1，ACK=1，seq=y随机，ack=x+1

3：携带数据，客户端分配缓存，SYN=0，ACK=1，seq=x+1，ack=y+1

![image-20240927155337159](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240927155337159.png)

（2）**连接释放（四次挥手）**

1：客户端停止数据发送，FIN=1，seq=u已传送最后一个序号+1

2：服务端发回确认，ACK=1，seq=v已传送最后一个序号+1，ack=u+1

3：服务端请求连接释放，FIN=1，ACK=1，seq=w，ack=u+1

4：客户端回复确认，等待2MSL（最长报文段寿命）后，连接完全关闭，ACK=1，seq=u+1，ack=w+1

![image-20240927155417442](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240927155417442.png)

### 4、可靠传输

4种可靠传输机制：校验、序号、确认、重传

（1）**校验**

与UDP一致，加伪首部，求二进制反码

（2）**序号**

每个报文的**长度不定**

seq = 发送的数据**第一个字节**的序号

（3）**确认**

使用**累积确认**

ack = 希望收到的**下一个字节**序号 = 上一个收到的最后一个字节序号+1

（4）**重传**

动态改变重传时间RTTs = 前面**所有**传输报文段的RTT的**平均值**

冗余ACK：每当报文失序时，发送一个冗余ACK，指明期待收到的下一个字节序号

**快速重传**：发送方连续收到**3次**冗余ACK，**立即重传**

### 5、流量控制

接收窗口rwnd=**接收方**ACK报文的窗口字段

发送窗口=**min**{接收窗口rwnd,拥塞窗口cwnd}

收到**零窗口**通知后，过一段时间会发送**探测报文段**，对方回复现在端口值

### 6、拥塞控制

拥塞窗口cwnd=**发送方**根据当前网络设置的窗口值

（1）**慢开始**

cwnd初始为：1个报文段

**指数级别**增长cwnd（每经过一个RTT，cwnd*=2）

（2）**拥塞避免**

**慢开始门限ssthresh**=当前的cwnd/2

cwnd<ssthresh，慢开始（**指数**增长）
cwnd>ssthresh，拥塞避免（**线性**增长）

一旦发生拥塞，更新ssthresh，cwnd=1

![image-20240929165218697](C:\Users\CC507\AppData\Roaming\Typora\typora-user-images\image-20240929165218697.png)

（3）**快重传**

收到**3个冗余ACK**，立即重传丢失报文段

（4）快恢复

一旦发生拥塞，**ssthresh=cwnd=cwnd/2**，之后**线性**增加
